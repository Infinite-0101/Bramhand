<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Particle Core - Gestures Fixed</title>

    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>

    <style>
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; background: #000; overflow: hidden; font-family: monospace; }
        canvas { display: block; width: 100vw; height: 100vh; transform: scaleX(-1); /* Mirror effect */ }
        
        #ui-layer {
            position: absolute; top: 10px; left: 10px; color: #fff; z-index: 10;
            pointer-events: none; background: rgba(0,0,0,0.5); padding: 10px; border-radius: 8px;
        }
        .highlight { color: #FFA500; font-weight: bold; }
        .status { color: #00FFFF; font-weight: bold; font-size: 1.2em; }
    </style>
</head>
<body>

    <div id="ui-layer">
        <strong>DEBUG MODE</strong><br>
        <span class="highlight">Status:</span> <span id="status-text">Loading Model...</span><br>
        <span class="highlight">Fingers Detected:</span> <span id="finger-count" class="status">-</span>
    </div>

    <video id="input_video" style="display:none;" playsinline muted autoplay></video>
    
    <canvas id="output_canvas"></canvas>

    <script>
        const videoElement = document.getElementById('input_video');
        const canvasElement = document.getElementById('output_canvas');
        const canvasCtx = canvasElement.getContext('2d');
        const statusText = document.getElementById('status-text');
        const fingerCountText = document.getElementById('finger-count');

        // Resize canvas function
        function resize() {
            canvasElement.width = window.innerWidth;
            canvasElement.height = window.innerHeight;
        }
        window.addEventListener('resize', resize);
        resize();

        // --- 2. GESTURE LOGIC (The "Math") ---
        function countFingers(landmarks) {
            let count = 0;
            // Thumb (Logic: Tip x is outside IP x) - Simplified for right hand/mirroring
            // Note: Thumb is tricky, this is a basic check
            if (landmarks[4].x < landmarks[3].x) count++; 

            // Other 4 fingers (Logic: Tip y is above PIP y)
            // Index (8 vs 6)
            if (landmarks[8].y < landmarks[6].y) count++;
            // Middle (12 vs 10)
            if (landmarks[12].y < landmarks[10].y) count++;
            // Ring (16 vs 14)
            if (landmarks[16].y < landmarks[14].y) count++;
            // Pinky (20 vs 18)
            if (landmarks[20].y < landmarks[18].y) count++;

            return count;
        }

        // --- 3. RESULTS HANDLER ---
        function onResults(results) {
            // A. Clear screen
            canvasCtx.save();
            canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
            
            // B. Draw Camera Feed (optional)
            canvasCtx.drawImage(results.image, 0, 0, canvasElement.width, canvasElement.height);

            // C. Check if hands are found
            if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
                statusText.innerText = "Tracking Hand";
                statusText.style.color = "#00FF00";

                for (const landmarks of results.multiHandLandmarks) {
                    // D. Draw Skeleton (Red lines)
                    drawConnectors(canvasCtx, landmarks, HAND_CONNECTIONS, {color: '#00FF00', lineWidth: 5});
                    drawLandmarks(canvasCtx, landmarks, {color: '#FF0000', lineWidth: 2});

                    // E. Calculate Gestures
                    const fingers = countFingers(landmarks);
                    fingerCountText.innerText = fingers;

                    // --- YOUR PARTICLE TRIGGERS GO HERE ---
                    // if (fingers === 1) { ... triggerHeart() ... }
                    // if (fingers === 2) { ... triggerFlower() ... }
                }
            } else {
                statusText.innerText = "Show Hand...";
                statusText.style.color = "yellow";
                fingerCountText.innerText = "0";
            }
            canvasCtx.restore();
        }

        // --- 4. INITIALIZE MEDIAPIPE HANDS ---
        const hands = new Hands({locateFile: (file) => {
            return `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`;
        }});

        hands.setOptions({
            maxNumHands: 1,
            modelComplexity: 1,
            minDetectionConfidence: 0.5,
            minTrackingConfidence: 0.5
        });

        hands.onResults(onResults);

        // --- 5. START CAMERA (Mobile Safe) ---
        const camera = new Camera(videoElement, {
            onFrame: async () => {
                await hands.send({image: videoElement});
            },
            width: 1280,
            height: 720
        });

        camera.start()
            .then(() => { console.log("Camera started"); })
            .catch(err => { 
                console.error(err);
                alert("Camera error: " + err); 
            });

    </script>
</body>
</html>
